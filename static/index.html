<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Coin Trading Bot</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="login-container" class="container">
        <div class="card login-card">
            <h1>Multi-Coin Bot Kontrol Paneli</h1>
            <p class="subtitle">LÃ¼tfen giriÅŸ yapÄ±n</p>
            <div class="form-group">
                <label for="email">E-posta</label>
                <input type="email" id="email" placeholder="ornek@mail.com" autocomplete="email">
            </div>
            <div class="form-group">
                <label for="password">Åifre</label>
                <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
            </div>
            <button id="login-button" class="btn btn-start">GiriÅŸ Yap</button>
            <p id="login-error" class="error-message"></p>
        </div>
    </div>

    <div id="app-container" class="container" style="display: none;">
        <header>
            <h1>ğŸš€ Multi-Coin Trading Bot</h1>
            <button id="logout-button" class="btn btn-logout">Ã‡Ä±kÄ±ÅŸ Yap</button>
        </header>

        <main>
            <!-- Bot KontrolÃ¼ -->
            <div class="card controls-card">
                <h2>ğŸ¤– Bot YÃ¶netimi</h2>
                <div class="button-group">
                    <button id="start-monitoring-button" class="btn btn-start">Bot'u BaÅŸlat</button>
                    <button id="stop-all-button" class="btn btn-stop" disabled>TÃ¼mÃ¼nÃ¼ Durdur</button>
                </div>
            </div>

            <!-- Yeni Coin Ekleme -->
            <div class="card add-coin-card">
                <h2>â• Yeni Coin Ekle</h2>
                <div class="form-group">
                    <label for="symbol-input">Coin Sembolu</label>
                    <input type="text" id="symbol-input" placeholder="Ã–rn: BTCUSDT">
                </div>
                <div class="form-group">
                    <label for="order-size-input">Ä°ÅŸlem Boyutu (USDT)</label>
                    <input type="number" id="order-size-input" placeholder="50" min="1" step="0.01" value="50">
                </div>
                <button id="add-coin-button" class="btn btn-primary">Coin Ekle</button>
            </div>

            <!-- Genel Durum -->
            <div class="card status-card">
                <h2>ğŸ“Š Genel Durum</h2>
                <div class="status-grid">
                    <p class="status-label">Bot Durumu:</p>
                    <p class="status-value"><span id="bot-status">KapalÄ±</span></p>
                    <p class="status-label">Toplam Bakiye:</p>
                    <p class="status-value"><span id="total-balance">0.00 USDT</span></p>
                    <p class="status-label">Aktif Coin SayÄ±sÄ±:</p>
                    <p class="status-value"><span id="active-coins-count">0</span></p>
                    <p class="status-label">AÃ§Ä±k Pozisyon SayÄ±sÄ±:</p>
                    <p class="status-value"><span id="total-positions">0</span></p>
                    <p class="status-label">Mesaj:</p>
                    <p class="status-value"><span id="status-message">Bot baÅŸlatÄ±lmadÄ±.</span></p>
                </div>
            </div>

            <!-- Aktif Coin'ler -->
            <div class="card coins-card">
                <h2>ğŸª™ Ä°zlenen Coin'ler</h2>
                <div id="coins-container">
                    <p class="no-coins">HenÃ¼z coin eklenmedi.</p>
                </div>
            </div>

            <!-- Ä°statistikler -->
            <div class="card stats-card">
                <h2>ğŸ“ˆ Performans Ä°statistikleri</h2>
                <div class="stats-grid">
                    <p class="stats-label">Toplam Ä°ÅŸlem:</p>
                    <p class="stats-value" id="stats-total-trades">0</p>
                    <p class="stats-label">Kazanan Ä°ÅŸlem:</p>
                    <p class="stats-value" id="stats-winning-trades">0 (%0.0)</p>
                    <p class="stats-label">Kaybeden Ä°ÅŸlem:</p>
                    <p class="stats-value" id="stats-losing-trades">0 (%0.0)</p>
                    <p class="stats-label">Toplam KÃ¢r:</p>
                    <p class="stats-value" id="stats-total-profit">0.00 USDT</p>
                    <p class="stats-label">Toplam Zarar:</p>
                    <p class="stats-value" id="stats-total-loss">0.00 USDT</p>
                    <p class="stats-label">Net KÃ¢r/Zarar:</p>
                    <p class="stats-value" id="stats-net-pnl">0.00 USDT</p>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Firebase Configuration - KENDÄ° BÄ°LGÄ°LERÄ°NÄ°ZÄ° KULLANIN
            const firebaseConfig = {
                apiKey: "AIzaSyDkJch-8B46dpZSB-pMSR4q1uvzadCVekE",
                authDomain: "aviator-90c8b.firebaseapp.com",
                databaseURL: "https://aviator-90c8b-default-rtdb.firebaseio.com",
                projectId: "aviator-90c8b",
                storageBucket: "aviator-90c8b.appspot.com",
                messagingSenderId: "823763988442",
                appId: "1:823763988442:web:16a797275675a219c3dae3"
            };

            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const database = firebase.database();

            // HTML Elementleri
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            const loginButton = document.getElementById('login-button');
            const logoutButton = document.getElementById('logout-button');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('login-error');

            // Bot Kontrol Elementleri
            const startMonitoringButton = document.getElementById('start-monitoring-button');
            const stopAllButton = document.getElementById('stop-all-button');

            // Coin Ekleme Elementleri
            const symbolInput = document.getElementById('symbol-input');
            const orderSizeInput = document.getElementById('order-size-input');
            const addCoinButton = document.getElementById('add-coin-button');

            // Durum Elementleri
            const botStatusSpan = document.getElementById('bot-status');
            const totalBalanceSpan = document.getElementById('total-balance');
            const activeCoinsCountSpan = document.getElementById('active-coins-count');
            const totalPositionsSpan = document.getElementById('total-positions');
            const statusMessageSpan = document.getElementById('status-message');
            const coinsContainer = document.getElementById('coins-container');

            // Ä°statistik Elementleri
            const statsTotal = document.getElementById('stats-total-trades');
            const statsWinning = document.getElementById('stats-winning-trades');
            const statsLosing = document.getElementById('stats-losing-trades');
            const statsTotalProfit = document.getElementById('stats-total-profit');
            const statsTotalLoss = document.getElementById('stats-total-loss');
            const statsNetPnl = document.getElementById('stats-net-pnl');

            let statusInterval;

            // Kimlik DoÄŸrulama
            loginButton.addEventListener('click', () => {
                loginError.textContent = "";
                auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value)
                    .catch(error => {
                        console.error("GiriÅŸ hatasÄ±:", error);
                        loginError.textContent = "HatalÄ± e-posta veya ÅŸifre.";
                    });
            });

            logoutButton.addEventListener('click', () => {
                auth.signOut();
            });

            auth.onAuthStateChanged(user => {
                if (user) {
                    loginContainer.style.display = 'none';
                    appContainer.style.display = 'flex';
                    getStatus();
                    statusInterval = setInterval(getStatus, 3000);
                    listenForTradeUpdates();
                } else {
                    loginContainer.style.display = 'flex';
                    appContainer.style.display = 'none';
                    if (statusInterval) clearInterval(statusInterval);
                }
            });

            // API Ä°stekleri
            async function fetchApi(endpoint, options = {}) {
                const user = auth.currentUser;
                if (!user) {
                    console.warn("KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ.");
                    return null;
                }

                try {
                    const idToken = await user.getIdToken(true);
                    const headers = { ...options.headers, 'Authorization': `Bearer ${idToken}` };
                    if (options.body && !headers['Content-Type']) {
                        headers['Content-Type'] = 'application/json';
                    }

                    const response = await fetch(endpoint, { ...options, headers });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                        console.error("API HatasÄ±:", errorData.detail);
                        showError(errorData.detail);
                        return null;
                    }
                    return response.json();
                } catch (error) {
                    console.error("API isteÄŸi hatasÄ±:", error);
                    showError(`BaÄŸlantÄ± HatasÄ±: ${error.message}`);
                    return null;
                }
            }

            function showError(message) {
                statusMessageSpan.textContent = `âŒ ${message}`;
                statusMessageSpan.className = 'status-error';
            }

            function showSuccess(message) {
                statusMessageSpan.textContent = `âœ… ${message}`;
                statusMessageSpan.className = 'status-success';
            }

            // Bot Kontrol FonksiyonlarÄ±
            startMonitoringButton.addEventListener('click', async () => {
                const result = await fetchApi('/api/start-monitoring', { method: 'POST' });
                if (result) {
                    showSuccess("Bot monitoring baÅŸlatÄ±ldÄ±!");
                    updateUI(result.status);
                }
            });

            stopAllButton.addEventListener('click', async () => {
                const result = await fetchApi('/api/stop-all', { method: 'POST' });
                if (result) {
                    showSuccess("TÃ¼m iÅŸlemler durduruldu!");
                    updateUI(result.status);
                }
            });

            addCoinButton.addEventListener('click', async () => {
                const symbol = symbolInput.value.trim().toUpperCase();
                const orderSize = parseFloat(orderSizeInput.value);

                if (!symbol) {
                    showError("Coin sembolÃ¼ boÅŸ olamaz!");
                    return;
                }

                if (!orderSize || orderSize <= 0) {
                    showError("Ä°ÅŸlem boyutu 0'dan bÃ¼yÃ¼k olmalÄ±!");
                    return;
                }

                const result = await fetchApi('/api/add-coin', {
                    method: 'POST',
                    body: JSON.stringify({ symbol, order_size_usdt: orderSize })
                });

                if (result) {
                    showSuccess(`${symbol} baÅŸarÄ±yla eklendi!`);
                    symbolInput.value = '';
                    orderSizeInput.value = '50';
                    updateUI(result.status);
                }
            });

            // Coin KaldÄ±rma Fonksiyonu
            async function removeCoin(symbol) {
                if (!confirm(`${symbol} coin'ini kaldÄ±rmak istediÄŸinizden emin misiniz?\nAÃ§Ä±k pozisyon varsa kapatÄ±lacak!`)) {
                    return;
                }

                const result = await fetchApi('/api/remove-coin', {
                    method: 'POST',
                    body: JSON.stringify({ symbol })
                });

                if (result) {
                    showSuccess(`${symbol} baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±!`);
                    updateUI(result.status);
                }
            }

            // UI GÃ¼ncelleme
            function updateUI(data) {
                if (!data) return;

                // Genel durum gÃ¼ncelleme
                botStatusSpan.textContent = data.is_running ? 'ğŸŸ¢ Ã‡alÄ±ÅŸÄ±yor' : 'ğŸ”´ DurdurulmuÅŸ';
                botStatusSpan.className = data.is_running ? 'status-running' : 'status-stopped';

                totalBalanceSpan.textContent = `${data.total_balance ? data.total_balance.toFixed(2) : '0.00'} USDT`;
                activeCoinsCountSpan.textContent = Object.keys(data.active_coins || {}).length;
                totalPositionsSpan.textContent = data.total_positions || 0;
                statusMessageSpan.textContent = data.status_message || 'Bilinmeyen durum';

                // Buton durumlarÄ±
                startMonitoringButton.disabled = data.is_running;
                stopAllButton.disabled = !data.is_running;
                addCoinButton.disabled = !data.is_running;

                // Coin listesini gÃ¼ncelle
                updateCoinsDisplay(data.coin_details || {});
            }

            function updateCoinsDisplay(coinDetails) {
                if (Object.keys(coinDetails).length === 0) {
                    coinsContainer.innerHTML = '<p class="no-coins">HenÃ¼z coin eklenmedi.</p>';
                    return;
                }

                const coinsHTML = Object.entries(coinDetails).map(([symbol, details]) => {
                    const positionStatus = details.in_position ? 'ğŸŸ¢ Pozisyonda' : 'âšª Beklemede';
                    const positionSide = details.position_side || 'Yok';
                    const lastSignal = details.last_signal || 'N/A';
                    const orderSize = details.order_size_usdt || 0;
                    const pnl = details.pnl || 0;

                    return `
                        <div class="coin-item">
                            <div class="coin-header">
                                <h3>${symbol}</h3>
                                <button onclick="removeCoin('${symbol}')" class="btn-remove">ğŸ—‘ï¸</button>
                            </div>
                            <div class="coin-info">
                                <span class="coin-status ${details.in_position ? 'in-position' : ''}">${positionStatus}</span>
                                <span class="coin-side">${positionSide}</span>
                                <span class="coin-signal">ğŸ“Š ${lastSignal}</span>
                                <span class="coin-size">ğŸ’° ${orderSize} USDT</span>
                                <span class="coin-pnl ${pnl >= 0 ? 'positive' : 'negative'}">ğŸ“ˆ ${pnl.toFixed(2)} USDT</span>
                            </div>
                        </div>
                    `;
                }).join('');

                coinsContainer.innerHTML = coinsHTML;
            }

            // Global fonksiyon olarak removeCoin'i tanÄ±mla
            window.removeCoin = removeCoin;

            // Durum sorgulama
            async function getStatus() {
                const data = await fetchApi('/api/status');
                if (data) updateUI(data);
            }

            // Firebase Ä°statistikleri
            function listenForTradeUpdates() {
                const tradesRef = database.ref('trades');
                tradesRef.on('value', (snapshot) => {
                    const trades = snapshot.val() ? Object.values(snapshot.val()) : [];
                    calculateAndDisplayStats(trades);
                });
            }

            function calculateAndDisplayStats(trades) {
                let totalTrades = 0;
                let winningTrades = 0, losingTrades = 0;
                let totalProfit = 0, totalLoss = 0;

                trades.forEach(trade => {
                    if (trade.status && trade.status !== "OPEN") {
                        totalTrades++;
                        const pnl = parseFloat(trade.pnl) || 0;
                        if (pnl > 0) {
                            winningTrades++;
                            totalProfit += pnl;
                        } else if (pnl < 0) {
                            losingTrades++;
                            totalLoss += pnl;
                        }
                    }
                });

                const netPnl = totalProfit + totalLoss;

                statsTotal.textContent = totalTrades;
                const winRate = totalTrades > 0 ? ((winningTrades / totalTrades) * 100).toFixed(1) : 0;
                const loseRate = totalTrades > 0 ? ((losingTrades / totalTrades) * 100).toFixed(1) : 0;
                statsWinning.textContent = `${winningTrades} (%${winRate})`;
                statsLosing.textContent = `${losingTrades} (%${loseRate})`;

                formatPnl(statsTotalProfit, totalProfit);
                formatPnl(statsTotalLoss, totalLoss);
                formatPnl(statsNetPnl, netPnl);
            }

            function formatPnl(element, value) {
                element.textContent = `${value.toFixed(2)} USDT`;
                element.className = value > 0 ? 'stats-value pnl-positive' : (value < 0 ? 'stats-value pnl-negative' : 'stats-value');
            }
        });
    </script>
</body>
</html>
